SUBDIRS 		= @JTHREAD_DIRECTORIES@ 

JTHREAD_NAME		= libjthread
JTHREAD_VERS_MAJOR	= 1
JTHREAD_VERS_MINOR	= 0
JTHREAD_VERS_DEBUG	= 0
JTHREAD_STATIC		= $(JTHREAD_NAME).a
JTHREAD_DYNAMIC		= $(JTHREAD_NAME).so.$(JTHREAD_VERS_MAJOR).$(JTHREAD_VERS_MINOR).$(JTHREAD_VERS_DEBUG)
JTHREAD_DYNAMIC_INTERN	= $(JTHREAD_NAME).so.$(JTHREAD_VERS_MAJOR).$(JTHREAD_VERS_MINOR)
JTHREAD_DYNAMIC_SHORT	= $(JTHREAD_NAME).so

DISTRIBDIRS		= doc include lib src
DISTRIBFILES		= ChangeLog Makefile.in configure configure.in LICENSE.MIT README.TXT
DISTRIBARCHIVEDIR	= jthread-$(JTHREAD_VERS_MAJOR).$(JTHREAD_VERS_MINOR).$(JTHREAD_VERS_DEBUG)
SNAPSHOTARCHIVEDIR	= jthread-`date +"%Y%m%d"`

LDFLAGS 		= @JTHREAD_LDFLAGS@
ARFLAGS 		= @JTHREAD_ARFLAGS@

LIBRARYDIR 		= @prefix@/lib
INCLUDEDIR 		= @prefix@/include/jthread

all: @JTHREAD_TARGETS@

dummymsg:
	@echo "Nothing to build"
	
staticlib:
	@for i in $(SUBDIRS) ; do\
		if ! (cd $$i ; make) ; then\
			exit 1;\
		fi;\
	done
	rm -f $(JTHREAD_STATIC)
	ar $(ARFLAGS) $(JTHREAD_STATIC) lib/*.o

sharedlib:
	@for i in $(SUBDIRS) ; do\
		if ! (cd $$i ; make) ; then\
			exit 1;\
		fi;\
	done
	rm -f $(JTHREAD_DYNAMIC)
	ld $(LDFLAGS) $(JTHREAD_DYNAMIC_INTERN) -o $(JTHREAD_DYNAMIC) lib/*.o

clean:
	@for i in $(SUBDIRS) ; do\
		(cd $$i ; make clean) ;\
	done
	(cd lib; rm -f *.o)
	(cd include; rm -f *.h)
	rm -f $(JTHREAD_STATIC) $(JTHREAD_DYNAMIC)

distclean: clean
	rm -f `find . -name "Makefile"`
	rm -f config.log
	rm -f config.cache
	rm -f config.status
	rm -fr $(DISTRIBARCHIVEDIR)
	rm -f $(DISTRIBARCHIVEDIR).tar
	rm -f $(DISTRIBARCHIVEDIR).tar.gz
	rm -f $(DISTRIBARCHIVEDIR).tar.bz2
	rm -f $(DISTRIBARCHIVEDIR).zip
	rm -fr $(SNAPSHOTARCHIVEDIR)
	rm -f $(SNAPSHOTARCHIVEDIR).tar
	rm -f $(SNAPSHOTARCHIVEDIR).tar.gz
	rm -f $(SNAPSHOTARCHIVEDIR).tar.bz2
	rm -f $(SNAPSHOTARCHIVEDIR).zip
	rm -f .findscript

snapshot: clean
	rm -fr $(SNAPSHOTARCHIVEDIR)
	mkdir $(SNAPSHOTARCHIVEDIR)
	cp -f $(DISTRIBFILES) $(SNAPSHOTARCHIVEDIR)
	todos < jthread.dsp >$(SNAPSHOTARCHIVEDIR)/jthread.dsp
	todos < jthread.dsw >$(SNAPSHOTARCHIVEDIR)/jthread.dsw
	todos < copyheaderfiles.bat >$(SNAPSHOTARCHIVEDIR)/copyheaderfiles.bat
	cp -rf $(DISTRIBDIRS) $(SNAPSHOTARCHIVEDIR)
	echo find $(SNAPSHOTARCHIVEDIR)/ -name "CVS">.findscript
	chmod u+x .findscript
	rm -rf `./.findscript`
	echo find $(SNAPSHOTARCHIVEDIR)/ -name "Makefile">.findscript
	chmod u+x .findscript
	rm -rf `./.findscript`
	tar cf $(SNAPSHOTARCHIVEDIR).tar $(SNAPSHOTARCHIVEDIR)
	gzip -c $(SNAPSHOTARCHIVEDIR).tar > $(SNAPSHOTARCHIVEDIR).tar.gz
	bzip2 -c $(SNAPSHOTARCHIVEDIR).tar > $(SNAPSHOTARCHIVEDIR).tar.bz2
	echo find $(SNAPSHOTARCHIVEDIR) >.findscript
	chmod u+x .findscript
	zip $(SNAPSHOTARCHIVEDIR).zip `./.findscript`
	rm -f $(SNAPSHOTARCHIVEDIR).tar
	rm -fr $(SNAPSHOTARCHIVEDIR)
	rm -f .findscript

dist: clean
	rm -fr $(DISTRIBARCHIVEDIR)
	mkdir $(DISTRIBARCHIVEDIR)
	cp -f $(DISTRIBFILES) $(DISTRIBARCHIVEDIR)
	todos < jthread.dsp >$(DISTRIBARCHIVEDIR)/jthread.dsp
	todos < jthread.dsw >$(DISTRIBARCHIVEDIR)/jthread.dsw
	todos < copyheaderfiles.bat >$(DISTRIBARCHIVEDIR)/copyheaderfiles.bat
	cp -rf $(DISTRIBDIRS) $(DISTRIBARCHIVEDIR)
	rm -rf `find $(DISTRIBARCHIVEDIR)/ -name "CVS"`
	rm -rf `find $(DISTRIBARCHIVEDIR)/ -name "Makefile"`
	tar cf $(DISTRIBARCHIVEDIR).tar $(DISTRIBARCHIVEDIR)
	gzip -c $(DISTRIBARCHIVEDIR).tar > $(DISTRIBARCHIVEDIR).tar.gz
	bzip2 -c $(DISTRIBARCHIVEDIR).tar > $(DISTRIBARCHIVEDIR).tar.bz2
	zip $(DISTRIBARCHIVEDIR).zip `find $(DISTRIBARCHIVEDIR)`
	rm -f $(DISTRIBARCHIVEDIR).tar
	rm -fr $(DISTRIBARCHIVEDIR)

install: all
	if ! test -d $(LIBRARYDIR) ; then \
		mkdir -m 755 -p $(LIBRARYDIR) ; \
	fi
	if ! test -d $(INCLUDEDIR) ; then \
		mkdir -m 755 -p $(INCLUDEDIR) ; \
	fi
	if test -e $(JTHREAD_STATIC) ; then \
		install -m 644 $(JTHREAD_STATIC) $(LIBRARYDIR) ; \
	fi
	if test -e $(JTHREAD_DYNAMIC) ; then \
		install -m 755 $(JTHREAD_DYNAMIC) $(LIBRARYDIR) ; \
	fi
	install -m 644 include/*.h $(INCLUDEDIR)
	(cd $(LIBRARYDIR) ; ln -s $(JTHREAD_DYNAMIC) $(JTHREAD_DYNAMIC_SHORT))

